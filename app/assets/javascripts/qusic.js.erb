// = require 'vendor/snack-qwery'
// = require 'vendor/bonzo'


(function (w, d) {

  var $ = function (selector) {
    return bonzo(snack.qwery(selector))
  };

  if ($("#qusic-container").length > 0) {
    $("#qusic-container").show();
    return;
  }

  var detectYoutube = function () {
    var title = "", artist = "", splits, raw_title = $("#eow-title").text().replace(/\n|\s{2,}|\t|\r/g, '');

    if ($("#watch-headline-show-title").length > 0) {
      artist = $("#watch-headline-show-title").text();
      title = raw_title.replace(artist, '').replace(/:\-\â€“\-\-/g, '');
    } else {
      splits = raw_title.split(/\s*-\s*/);
      if (splits.length > 1) {
        title = splits[1];
        artist = splits[0];
      } else {
        title = splits[0];
      }

    }
    title = title.replace(/\s*\(.+\)/g, '').replace(/\s{2,}/g, '');
    return {artist:artist, trackname:title, href:document.location.href };
  };

  var byId = function (id) {
    return d.getElementById(id);
  };

  var buildRequestData = function (base) {
    var token = $("#qusic-script").data("qusic-token"),
      artist = $("#qusic-artist").val(),
      trackname = $("#qusic-trackname").val(),
      url = $("#qusic-href").val(),
      source = $("#qusic-src").val();
    return {source: source, artist: artist, trackname: trackname, url: url, token: token};
  };

  var feedBack = function(response) {
    if(response['response_code'] == 200) {
      alert("Done!")
      $("#qusic-container").hide();
    } else {
      alert(":( There was an error: " + response['error']);
    }
  };

  var submitInfo = function () {
    console.log("<%= Rails.env %>");
    var data = buildRequestData();
    var params = {
      url:'http://localhost:3000/tracker/new',
      data: data,
      key:'callback'
    };

    snack.JSONP(params, function (data) {
      feedBack(data);
    })
  };

  var div = d.createElement("div");

  div.setAttribute("id", "qusic-container");
  div.innerHTML = "<%= File.read(File.join(Rails.root, 'app','views', 'shared', '_bookmarklet.html')).delete("\n").gsub(/\"/,'\\"') %>";
  d.body.appendChild(div);

  var out = $("#qusic-format");

  if (d.location.host.match(/youtube\.com$/) != null) {
    out.text("Youtube detected.");
    var info = detectYoutube();
    $("#qusic-artist").attr("value", info.artist);
    $("#qusic-trackname").attr("value", info.trackname);
    $("#qusic-href").attr("value", info.href);
    $("#qusic-src").attr("value", "youtube");
  }

  if (d.location.host.match(/soundcloud\.com$/) != null) {
    out.text("Soundcloud not implemented yet.");
  }

  if (d.location.host.match(/mixcloud\.com$/) != null) {
    out.text("Mixcloud not implemented yet.");
  }


  snack.listener({
    node:byId('qusic-trackit'),
    event:'click'
  }, function () {
    submitInfo();
  });

})(window, document);




